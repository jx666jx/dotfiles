### VARS ###
# freedom from tyranny
TMOUT=0
# where are the files
SRE=~/projects-sre
PROJECT=~/projects
BIN=~/.local/bin
DOWNLOADS=~/dump
PYTHON=python3.13

# list aliases
alias ll='ls -la --group-directories-first'
alias la='ls -l --group-directories-first'
alias lf="ls -l | egrep -v '^d'"
alias ld='ls -ld */'
alias l='ls -Ca --group-directories-first'
alias lsp='ls -a '$PROJECT' --group-directories-first'
alias lss='ls -a '$SCRIPTS' --group-directories-first'
alias lsd='ls -a '$DOWNLOADS' --group-directories-first'
alias latr='ls -latr'

# cd aliases
alias cdb='cd '$BIN
alias cdd='cd '$DOWNLOADS
alias cdp='cd '$PROJECT
alias cds='cd '$SRE
alias cdz='cd '$ZSH_CUSTOM

# activate current venv
alias sv='source .venv/bin/activate'

# zshrc maintenace
alias zshrc='. ~/.zshrc'
alias zshrcv='vi ~/.zshrc'

# dig it
alias digs='dig +short '
alias digsr='dig @1.1.1.1 +short'

### VSCode
alias c='code'
# vscode refresh IPC
vscri() {
   export VSCODE_IPC_HOOK_CLI=$(lsof 2>/dev/null | grep $UID/vscode-ipc | awk '{print $(NF-1)}' | head -n 1) 
}

### GLab
alias gl='glab'

### talosctl
alias t='talosctl'

### k8s
alias kl='~/bin/klogin.sh'
alias k='kubectl '
alias kns='kubens '
alias kcx='kubectx '

### docker
alias d='sudo docker '

### bat
alias cat='bat --paging=never'
batdiff() {
    git diff --name-only --relative --diff-filter=d -z | xargs -0 bat --diff
}
alias bathelp='bat --plain --language=help'
help() {
    "$@" --help 2>&1 | bathelp
}

### fzf
export FZF_DEFAULT_OPTS="--style full --preview 'fzf-preview.sh {}' --height 100% --layout reverse --border --preview-window=wrap"
export FZF_ALT_C_COMMAND="fd --type directory --hidden --exclude .venv --exclude .git"
export FZF_ALT_C_OPTS="--preview 'tree -C {}'"
export FZF_CTRL_T_COMMAND="fd --hidden --exclude .venv --exclude .git"
export FZF_CTRL_T_OPTS="--preview '[ -d {} ] && tree -C {} || bat --color=always --style=numbers {}'"

### ripgrep
rgg() {
RG_PREFIX="rg --column --line-number --no-heading --color=always --smart-case --hidden "
INITIAL_QUERY="${*:-}"
fzf --ansi --disabled --query "$INITIAL_QUERY" \
    --bind "start:reload:$RG_PREFIX {q}" \
    --bind "change:reload:sleep 0.1; $RG_PREFIX {q} || true" \
    --delimiter : \
    --preview 'bat --color=always {1} --highlight-line {2}' \
    --preview-window 'up,60%,border-bottom,+{2}+3/3,~3' \
    --bind 'enter:become(vim {1} +{2})'
}

# show formatted json
jxson() {
    cat $1 | $PYTHON -c "import sys, json; parse=(json.load(sys.stdin)); print (json.dumps(parse, indent=4))"
}

# make dir and enter
mcd() {
    mkdir -p $1
    cd $1
}

# tmux stuff
alias tls='tmux ls'
tat() {
    select sel in $(tmux ls -F '#{session_name}' ); do break; done
    tmux attach -t "$sel"
}
tla() {
    select sel in $(tmux ls -F '#{session_name}'); do break; done
    tmux attach -t "$sel"
}
logz() {
    tmux new-session -d -s logz -n 'sys_logs' >/dev/null
    tmux splitw -v -t logz:1.1
    tmux select-pane -t logz:1.1
    tmux send-keys -t logz:1.1 'tail -f /var/log/syslog' Enter
    tmux select-pane -t logz:1.2
    tmux send-keys -t logz:1.2 'tail -f /var/log/dmesg' Enter

    tmux new-window -t logz -n 'apache_logs' >/dev/null
    tmux splitw -v -t logz:2.1
    tmux select-pane -t logz:2.1
    tmux send-keys -t logz:2.1 'tail -f /var/log/apache2/access.log' Enter
    tmux select-pane -t logz:2.2
    tmux send-keys -t logz:2.2 'tail -f /var/log/apache2/error.log' Enter

    tmux a -t logz
}

# ansible shorts
apn() {
 ansible-playbook $1 -i ~/ansible-inventory/inventory-nsx.yml
}
apc() {
 ansible-playbook $1 -i ~/ansible-inventory/inventory-core.yml
}
apcv() {
 ansible-playbook -vvv $1 -i ~/ansible-inventory/inventory-core.yml
}

# python stuff
cvenv() {
    $PYTHON -m venv .venv --prompt=$1
    source .venv/bin/activate
    pip install wheel 
    pipup
    if [ -f requirements.txt ]; then
        pip install -r requirements.txt
    fi
}
pipin() {
    pip install $*
    #pip install  --no-index --find-links file://$PROJECT/ $*
}
pipup(){
    pip list --outdated --format=json | jq -r '.[] | "\(.name)==\(.latest_version)"' | xargs -n1 pip install -U
}
pipl() {
    pip list
}
pipfree() {
    pip freeze --all > requirements.txt
}

# cd function that will activate venv in current path
function cd() {
  builtin cd "$@"
  ## Default path to virtualenv in your projects
  DEFAULT_ENV_PATH="./.venv"
  function activate_venv() {
    if [[ -f "${DEFAULT_ENV_PATH}/bin/activate" ]] ; then 
      source "${DEFAULT_ENV_PATH}/bin/activate"
      echo -e "\e[42mactivating:\e[0m ${VIRTUAL_ENV}"
    fi
  }
  if [[ -z "$VIRTUAL_ENV" ]] ; then
    activate_venv
  else
    ## check the current folder belong to earlier VIRTUAL_ENV folder
    # if yes then do nothing
    # else deactivate then run a new env folder check
      parentdir="$(dirname ${VIRTUAL_ENV})"
      if [[ "$PWD"/ != "$parentdir"/* ]] ; then
        echo -e "\e[0;41mdeactivating:\e[0m ${VIRTUAL_ENV}"
        deactivate
        activate_venv
      fi
  fi
}

# enable color support of ls and also add handy aliases
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# Add an "alert" alias for long running commands.  Use like so:
#   sleep 10; alert
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"'
